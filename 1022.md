# Falcon Latency 측정 가이드 (2024-10-22)

## 1. 사전 준비
- `liboqs`를 `$HOME/liboqs-x86` 경로에 설치했습니다. 동일한 환경이 아니라면 PQ-V2Verifier README에 있는 설치 방법을 참고해 `liboqs`를 먼저 빌드/설치하세요.
- `falcon_sim` 바이너리와 자동화 스크립트는 현재 저장소에 포함되어 있습니다.

## 2. 빌드 방법
```bash
cmake -S . -B build
cmake --build build --target falcon_sim
```
- 빌드 후 실행 파일은 `build/falcon-sim/falcon_sim`에 생성됩니다.

## 3. 기본 실행 흐름 (레포 루트 기준)
1. **빌드**
   ```bash
   cmake -S . -B build
   cmake --build build --target falcon_sim
   ```
2. **측정 실행**  
   레포 루트(예: `~/v2verifier`)에서 반복 실행:
  ```bash
  V2X_TEST_PORT=6700 python3 scripts/run_remote_falcon.py \
    --binary build/falcon-sim/falcon_sim \
    --config falcon-sim/config.json \
    --scheme falcon \
    --fragment-sizes 192 \
    --runs 1000 \
    --base-port 6700 \
    --metrics-file results/falcon_metrics_192.csv \
    --log-dir logs/falcon_192 \
     --sleep-ms 200
   ```
   다른 fragment size(예: 224, 256)도 위 명령에서 `--fragment-sizes`와 `--base-port`, 출력 파일명을 바꿔 반복 실행하면 됩니다. 루트에서 실행하면 상대 경로 문제를 피할 수 있습니다.
   - 자동화 스크립트는 송신기와 수신기를 순차적으로 실행한 뒤 통신이 완료될 때까지 기다리며, 로그는 `logs/falcon_<fragment>/` 아래에 수신/송신 각각 남습니다.
   - 실행 중 `RuntimeError: Receiver exited with status -11` 등이 발생하면 보안 설정 또는 UDP 바인딩 문제가 있으니 아래 “빠른 환경 설정 예시”를 확인하세요.
   - 위 자동화 스크립트는 송신기와 수신기를 순차적으로 실행한 뒤 통신이 끝날 때까지 기다려 지표를 기록합니다. 실패하면 `logs/falcon_<fragment>/transmitter_run_xxxx.log` 및 `.../receiver_run_xxxx.log`에서 상세한 원인을 확인할 수 있습니다.
   - UDP가 차단된 환경에서는 송신기가 즉시 실패합니다. 이 경우 수동 동시 실행 방식(아래 참조)으로 직접 확인하거나, 제한 없는 환경에서 다시 측정을 진행해야 합니다.

3. **결과 정리**
  ```bash
  python3 scripts/metrics_report.py \
    --metrics results/falcon_metrics_192.csv \
     --output-markdown results/summary_192.md \
     --output-json results/summary_192.json
   ```
   CSV가 여러 개라면 필요에 따라 각각 요약하거나, 단일 CSV로 병합해 한 번에 요약할 수 있습니다.

## 5. 결과 요약
결과 CSV가 생성되면 `scripts/metrics_report.py`로 일정 조건을 요약할 수 있습니다.
```bash
python3 scripts/metrics_report.py \
  --metrics results/falcon_metrics.csv \
  --output-markdown results/summary.md \
  --output-json results/summary.json
```

## 6. 목표 성능
- 종료 지연 = 최종 전송 패킷 수신 시각 – 최초 전송 패킷 수신 시각.
- 각 조건에서 1000회 반복 후 평균 종료 지연을 계산합니다.
- 목표: 평균 종료 지연 1.5ms 이하를 달성.

## 7. 주의 사항
- 샌드박스 환경에서는 UDP 네트워킹 및 `sudo` 사용이 제한되어 있어 측정이 실패할 수 있습니다. 실제 실험은 네트워크 제약이 없는 환경에서 수행해야 합니다.
- `falcon_keys`, `cert_keys`, `keys`, `trace_files`는 모두 hex/PEM 파일로 포함되어 있으므로 별도의 키 생성 없이 바로 테스트 가능합니다.
- `v2verifier-app`의 기본 예제 실행(`build/v2verifier-app/v2verifier dsrc receiver --test --gui`)은 상대경로 `../../test_key.pem`을 사용합니다. 따라서 **프로젝트 루트(`~/v2verifier/`)에 `test_key.pem`과 필요 시 `test_cert.pem`을 복사**해 두고, 실행할 때는 `build/v2verifier-app`에서 명령을 실행하면 경로 문제가 발생하지 않습니다. 샌드박스 안에서는 GUI/UDP 사용이 제약될 수 있으니 참고하세요.
- README.md의 안내처럼 송신기와 수신기 두 프로세스를 동시에 띄워야 합니다. `run_remote_falcon.py`는 이를 자동으로 실행하지만, 수동으로 검증하고 싶다면 별도 터미널 두 개에서 다음 명령을 실행하십시오.
  ```bash
  # 터미널 1 (수신기)
  cd ~/v2verifier
  V2X_CONFIG_PATH=falcon-sim/config.json \
  V2X_SIGNATURE_SCHEME=falcon \
  ./build/falcon-sim/falcon_sim dsrc receiver nogui --test

  # 터미널 2 (송신기)
  cd ~/v2verifier
  V2X_CONFIG_PATH=falcon-sim/config.json \
  V2X_SIGNATURE_SCHEME=falcon \
  ./build/falcon-sim/falcon_sim dsrc transmitter nogui --test
  ```
  (GUI가 필요하면 `nogui`를 `tkgui`로 변경하되, 현재 `falcon_sim`은 GUI 지원이 제한적이므로 `v2verifier-app` 메인 바이너리를 사용하는 편이 낫습니다.)
  송신과 수신이 모두 동작해야 지표 측정이 가능하며, 현재 샌드박스에서는 송신기가 UDP 포트를 열지 못해 실패할 수 있습니다. 네트워크 제한이 없는 환경에서 실행하면 README에 설명된 방식대로 정상 작동합니다.

- **빠른 환경 설정 예시**
  - 테스트 전용(보안 끔)
    ```bash
    cat > /home/vboxuser/v2verifier/config.json <<'JSON'
    {
      "security": { "enabled": false },
      "test": {
        "socket_host": "127.0.0.1",
        "socket_port": 47001
      }
    }
    JSON
    ```
    이후 레포 루트에서 수신기를 먼저 실행한 뒤 송신기를 실행합니다.
  - 보안 유지(PEM 경로 지정)
    ```bash
    cat > /home/vboxuser/v2verifier/config.json <<'JSON'
    {
      "security": {
        "enabled": true,
        "private_key_pem": "/home/vboxuser/v2verifier/keys/vehicle.key.pem",
        "certificate_pem": "/home/vboxuser/v2verifier/keys/vehicle.cert.pem",
        "ca_bundle_pem": "/home/vboxuser/v2verifier/keys/ca-falcon.pem"
      },
      "test": {
        "socket_host": "127.0.0.1",
        "socket_port": 47001
      }
    }
    JSON
    chmod 600 /home/vboxuser/v2verifier/keys/*.key.pem 2>/dev/null || true
    ```
    이 경우에도 수신기를 먼저 띄우고 송신기를 실행해야 합니다. `ss -ltnp | grep 47001` 으로 수신 포트가 리슨 중인지 확인할 수 있습니다.
- 경로 문제가 의심되면 `V2X_CONFIG_PATH=/home/vboxuser/v2verifier/config.json` 과 같이 절대경로를 명시하세요. (샌드박스에서는 `strace`가 막혀 있으므로, `strace` 활용 안내는 실제 로컬 환경에서만 유효합니다.)

## 8. 현재 샌드박스에서의 상태 요약
- `falcon_sim`/`run_remote_falcon.py`는 송신기와 수신기를 모두 실행하도록 정상 구성되었습니다.
- 하지만 샌드박스 환경에서는 UDP 바인딩이 제한돼 송신기가 즉시 종료되고, 수신기는 `Calculated heading: 0` 로그만 반복 출력합니다(기본 트레이스에는 heading이 0으로 기록됨).
- **목표**  
  - 종료 지연 = 최종 전송 패킷 수신 시각 – 최초 전송 패킷 수신 시각  
  - 각 조건에서 1000회 반복 후 평균을 계산  
  - 평균 종료 지연 1.5ms 이하 달성을 분명한 목표로 설정했습니다.
- **진행 상황**  
  - 코드, 키, 트레이스, 자동화 스크립트까지 모두 레포에 포함되어 있으며 상대경로/환경변수 문제도 문서화했습니다.
  - UDP가 허용되는 환경에서 `run_remote_falcon.py` 또는 수동 실행을 통해 Sender/Receiver를 동시에 띄우면 README/문서 설명대로 정상 측정이 가능합니다.
- **앞으로**  
  - 로컬 머신처럼 네트워크 제약이 없는 환경에서 1000회 반복 측정(예: fragment 192/224/256)을 수행한 뒤, `scripts/metrics_report.py`로 평균 종료 시간(≤1.5ms 달성 여부)을 확인해 주세요.  
  - 문서에 기재된 설정(환경변수, 예치 파일 경로 등)을 그대로 따르면 실행 과정에서 경로 오류/키 로딩 오류가 발생하지 않습니다.
